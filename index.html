<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Envoyer un mail avec l'API Gmail</title>
<script src="https://apis.google.com/js/api.js"></script>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<h2>Envoyer un mail via l’API Gmail</h2>

<button id="authorize_button">Se connecter à Gmail</button>
<button id="signout_button" style="display:none">Se déconnecter</button>

<form id="email_form" style="margin-top:20px; display:none;">
  <label>Destinataire :</label><br />
  <input type="email" id="to" placeholder="ex: jean@exemple.fr" required /><br /><br />

  <label>Sujet :</label><br />
  <input type="text" id="subject" placeholder="Sujet du mail" required /><br /><br />

  <label>Message :</label><br />
  <textarea id="body" rows="6" cols="50" placeholder="Tape ton message ici" required></textarea><br /><br />

  <button type="submit">Envoyer</button>
</form>

<script>
  const CLIENT_ID = '454242049005-j9uhmcc6c1ta22vkma07g5063oei20a7.apps.googleusercontent.com'; // Remplace par ton client ID
  const API_KEY = 'api-gmail-461709'; // Remplace par ta clé API
  const SCOPES = 'https://www.googleapis.com/auth/gmail.send';

  let GoogleAuth;

  function handleClientLoad() {
    gapi.load('client:auth2', initClient);
  }

  function initClient() {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      scope: SCOPES,
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest']
    }).then(() => {
      GoogleAuth = gapi.auth2.getAuthInstance();

      // Écoute les changements d’état de connexion
      GoogleAuth.isSignedIn.listen(updateSigninStatus);

      // Initialisation de l’interface
      updateSigninStatus(GoogleAuth.isSignedIn.get());

      document.getElementById('authorize_button').onclick = () => GoogleAuth.signIn();
      document.getElementById('signout_button').onclick = () => GoogleAuth.signOut();
    });
  }

  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      document.getElementById('authorize_button').style.display = 'none';
      document.getElementById('signout_button').style.display = 'inline-block';
      document.getElementById('email_form').style.display = 'block';
    } else {
      document.getElementById('authorize_button').style.display = 'inline-block';
      document.getElementById('signout_button').style.display = 'none';
      document.getElementById('email_form').style.display = 'none';
    }
  }

  function encodeEmail(to, subject, body) {
    const str = 
      `To: ${to}\r\n` +
      `Subject: ${subject}\r\n` +
      `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
      `${body}`;
    // base64url encode
    return btoa(unescape(encodeURIComponent(str)))
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, '');
  }

  document.getElementById('email_form').addEventListener('submit', function(e) {
    e.preventDefault();
    const to = document.getElementById('to').value;
    const subject = document.getElementById('subject').value;
    const body = document.getElementById('body').value;

    const raw = encodeEmail(to, subject, body);

    gapi.client.gmail.users.messages.send({
      userId: 'me',
      resource: {
        raw: raw
      }
    }).then(response => {
      alert('Mail envoyé !');
      console.log('Réponse API Gmail:', response);
      this.reset();
    }, err => {
      alert('Erreur lors de l’envoi : ' + err.result.error.message);
      console.error(err);
    });
  });

  // Charger la lib Google API et lancer l’init
  handleClientLoad();
</script>

</body>
</html>
