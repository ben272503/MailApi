<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Connexion Gmail avec GIS</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <button id="authorize_button" style="display:none;">Se connecter</button>
  <button id="signout_button" style="display:none;">Déconnexion</button>
  <div id="status"></div>
  <textarea id="message" rows="5" cols="40" placeholder="Écris ton message ici"></textarea><br />
  <button id="send_button" disabled>Envoyer email</button>

  <script>
    const CLIENT_ID = 'TON_CLIENT_ID.apps.googleusercontent.com';
    const API_KEY = 'TA_CLE_API';
    const SCOPES = 'https://www.googleapis.com/auth/gmail.send';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let accessToken = null;

    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton = document.getElementById('signout_button');
    const sendButton = document.getElementById('send_button');
    const statusDiv = document.getElementById('status');

    // Charge la Google API
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // Initialise le client GIS
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error !== undefined) {
            throw tokenResponse;
          }
          accessToken = tokenResponse.access_token;
          sendButton.disabled = false;
          statusDiv.textContent = 'Connecté, prêt à envoyer un email.';
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'inline-block';
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    // Active les boutons si les deux APIs sont prêtes
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        authorizeButton.style.display = 'inline-block';
      }
    }

    authorizeButton.onclick = () => {
      tokenClient.requestAccessToken();
    };

    signoutButton.onclick = () => {
      if (accessToken) {
        google.accounts.oauth2.revoke(accessToken);
        accessToken = null;
        sendButton.disabled = true;
        statusDiv.textContent = 'Déconnecté.';
        authorizeButton.style.display = 'inline-block';
        signoutButton.style.display = 'none';
      }
    };

    // Envoi d’email simplifié
    async function sendEmail() {
      const message = document.getElementById('message').value.trim();
      if (!message) {
        alert('Merci d\'écrire un message.');
        return;
      }

      const email = 
        `To: benjamin24.joke@gmail.com\r\n` +
        `Subject: Message depuis mon site\r\n` +
        `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
        `${message}`;

      const encodedEmail = btoa(unescape(encodeURIComponent(email))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

      try {
        await gapi.client.gmail.users.messages.send({
          userId: 'me',
          resource: {
            raw: encodedEmail,
          }
        });
        statusDiv.textContent = 'Email envoyé !';
      } catch (e) {
        console.error(e);
        statusDiv.textContent = 'Erreur lors de l\'envoi de l\'email.';
      }
    }

    sendButton.onclick = sendEmail;

    // Charge les APIs quand le script est chargé
    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>
