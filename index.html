<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Envoyer un email via Gmail API</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f4f4f4;
    }

    .container {
      text-align: center;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgb(0 0 0 / 0.1);
      width: 320px;
    }

    textarea {
      width: 100%;
      resize: vertical;
      font-size: 14px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      font-family: Arial, sans-serif;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      transition: background-color 0.3s;
    }

    button:hover:not(:disabled) {
      background-color: #2980b9;
    }

    button:disabled {
      background-color: #a0c5e8;
      cursor: not-allowed;
    }

    #status {
      margin-top: 15px;
      font-weight: bold;
      min-height: 24px;
      font-family: Arial, sans-serif;
    }
  </style>

  <!-- Charge les librairies Google -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>

<body>
  <div class="container">
    <h2>Envoyer un email via Gmail</h2>

    <textarea id="message" rows="5" placeholder="Écris ton message ici..."></textarea>
    <input type="file" id="attachment" multiple/>

    <div>
      <button id="authorize_button" style="display:none;">Se connecter à Gmail</button>
      <button id="signout_button" style="display:none;">Déconnexion</button>
    </div>

    <button id="send_button" disabled>Envoyer l'email</button>

    <div id="status"></div>
  </div>

<script src="https://apis.google.com/js/api.js"></script>
<script>
  const CLIENT_ID = '454242049005-78upa3iiobs9nu72avo3m5aeri7ptt7g.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyBnoXIDbrGoBJorZQWx1gT1XFHlWU-3oio';
  const SCOPES = 'https://www.googleapis.com/auth/gmail.send';
  const RECIPIENTS = ['benjamin24.joke@gmail.com', 'benjamins.vendee.globe@gmail.com'];

  const authorizeButton = document.getElementById('authorize_button');
  const sendButton = document.getElementById('send_button');
  const statusDiv = document.getElementById('status');

  function base64urlEncode(str) {
    return btoa(unescape(encodeURIComponent(str)))
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, '');
  }

  function makeEmailWithAttachments(to, subject, message, files) {
    return new Promise((resolve, reject) => {
      const boundary = "boundary_" + Math.random().toString(36).substring(2);
      const readerPromises = Array.from(files).map(file => new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          res({
            name: file.name,
            type: file.type || 'application/octet-stream',
            content: base64
          });
        };
        reader.onerror = rej;
        reader.readAsDataURL(file);
      }));

      Promise.all(readerPromises).then(attachments => {
        let email =
`To: ${to}
Subject: ${subject}
Content-Type: multipart/mixed; boundary="${boundary}"

--${boundary}
Content-Type: text/plain; charset="UTF-8"

${message}`;

        attachments.forEach(att => {
          email += `

--${boundary}
Content-Type: ${att.type}; name="${att.name}"
Content-Disposition: attachment; filename="${att.name}"
Content-Transfer-Encoding: base64

${att.content}`;
        });

        email += `\n--${boundary}--`;

        resolve(base64urlEncode(email));
      }).catch(reject);
    });
  }

  async function sendEmail() {
    const message = document.getElementById('message').value.trim();
    const fileInput = document.getElementById('attachment');
    const files = fileInput.files;

    if (!message) {
      alert("Merci d'écrire un message.");
      return;
    }

    try {
      for (const to of RECIPIENTS) {
        const raw = files.length > 0
          ? await makeEmailWithAttachments(to, 'Message depuis mon site', message, files)
          : base64urlEncode(
              `To: ${to}\r\nSubject: Message depuis mon site\r\nContent-Type: text/plain; charset="UTF-8"\r\n\r\n${message}`
            );

        await gapi.client.gmail.users.messages.send({
          userId: 'me',
          resource: { raw }
        });
      }

      statusDiv.textContent = 'Emails envoyés avec succès !';
      statusDiv.style.color = 'green';
    } catch (e) {
      console.error(e);
      statusDiv.textContent = 'Erreur lors de l’envoi des emails.';
      statusDiv.style.color = 'red';
    }
  }

  function handleClientLoad() {
    gapi.load('client:auth2', initClient);
  }

  function initClient() {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"],
      scope: SCOPES
    }).then(() => {
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

      authorizeButton.onclick = () => gapi.auth2.getAuthInstance().signIn();
      sendButton.onclick = sendEmail;
    }, (error) => {
      console.error(error);
      statusDiv.textContent = 'Erreur lors de l\'initialisation de l\'API.';
      statusDiv.style.color = 'red';
    });
  }

  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      authorizeButton.style.display = 'none';
      sendButton.disabled = false;
      statusDiv.textContent = 'Connecté à Gmail. Tu peux envoyer un email.';
      statusDiv.style.color = 'green';
    } else {
      authorizeButton.style.display = 'inline-block';
      sendButton.disabled = true;
      statusDiv.textContent = 'Non connecté.';
      statusDiv.style.color = 'red';
    }
  }

  window.onload = handleClientLoad;
</script>

</body>
</html>
