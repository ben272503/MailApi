<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Envoyer un email via Gmail API</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f4f4f4;
    }

    .container {
      text-align: center;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgb(0 0 0 / 0.1);
      width: 320px;
    }

    textarea {
      width: 100%;
      resize: vertical;
      font-size: 14px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      font-family: Arial, sans-serif;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      transition: background-color 0.3s;
    }

    button:hover:not(:disabled) {
      background-color: #2980b9;
    }

    button:disabled {
      background-color: #a0c5e8;
      cursor: not-allowed;
    }

    #status {
      margin-top: 15px;
      font-weight: bold;
      min-height: 24px;
      font-family: Arial, sans-serif;
    }
  </style>

  <!-- Charge les librairies Google -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>

<body>
  <div class="container">
    <h2>Envoyer un email via Gmail</h2>

    <textarea id="message" rows="5" placeholder="Écris ton message ici..."></textarea>

    <div>
      <button id="authorize_button" style="display:none;">Se connecter à Gmail</button>
      <button id="signout_button" style="display:none;">Déconnexion</button>
    </div>

    <button id="send_button" disabled>Envoyer l'email</button>

    <div id="status"></div>
  </div>

  <script>
    // Remplace par tes infos Google Cloud Console
    const CLIENT_ID = '454242049005-78upa3iiobs9nu72avo3m5aeri7ptt7g.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBnoXIDbrGoBJorZQWx1gT1XFHlWU-3oio';
    const SCOPES = 'https://www.googleapis.com/auth/gmail.send';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let accessToken = null;

    const authorizeButton = document.getElementById('authorize_button');
    const signoutButton = document.getElementById('signout_button');
    const sendButton = document.getElementById('send_button');
    const statusDiv = document.getElementById('status');

    // Charge la Google API Client
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // Initialise Google Identity Services client
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error !== undefined) {
            console.error('Token error:', tokenResponse);
            statusDiv.textContent = 'Erreur d\'authentification';
            statusDiv.style.color = 'red';
            return;
          }
          accessToken = tokenResponse.access_token;
          sendButton.disabled = false;
          statusDiv.textContent = 'Connecté, prêt à envoyer un email.';
          statusDiv.style.color = 'green';
          authorizeButton.style.display = 'none';
          signoutButton.style.display = 'inline-block';
        },
      });
      gisInited = true;
      maybeEnableButtons();
    }

    // Active les boutons si les deux APIs sont prêtes
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        authorizeButton.style.display = 'inline-block';
      }
    }

    // Quand on clique sur "Se connecter"
    authorizeButton.onclick = () => {
      tokenClient.requestAccessToken();
    };

    // Quand on clique sur "Déconnexion"
    signoutButton.onclick = () => {
      if (accessToken) {
        google.accounts.oauth2.revoke(accessToken);
        accessToken = null;
        sendButton.disabled = true;
        statusDiv.textContent = 'Déconnecté.';
        statusDiv.style.color = 'black';
        authorizeButton.style.display = 'inline-block';
        signoutButton.style.display = 'none';
      }
    };

    // Fonction pour encoder en base64url
    function base64urlEncode(str) {
      return btoa(unescape(encodeURIComponent(str)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    // Crée le corps du mail au format raw
    function makeEmailBody(to, subject, message) {
      return (
        `To: ${to}\r\n` +
        `Subject: ${subject}\r\n` +
        `Content-Type: text/plain; charset="UTF-8"\r\n\r\n` +
        `${message}`
      );
    }

    // Envoie un email à une adresse
    async function sendEmail() {
      const message = document.getElementById('message').value.trim();
      if (!message) {
        alert('Merci d\'écrire un message.');
        return;
      }

      // Liste des destinataires fixes ici
      const recipients = ['benjamin24.joke@gmail.com', 'benjamins.vendee.globe@gmail.com'];

      try {
        for (const to of recipients) {
          const raw = base64urlEncode(makeEmailBody(to, 'Message depuis mon site', message));
          await gapi.client.gmail.users.messages.send({
            userId: 'me',
            resource: { raw },
          });
        }
        statusDiv.textContent = 'Emails envoyés avec succès !';
        statusDiv.style.color = 'green';
      } catch (e) {
        console.error(e);
        statusDiv.textContent = 'Erreur lors de l’envoi des emails.';
        statusDiv.style.color = 'red';
      }
    }

    sendButton.onclick = sendEmail;

    // Démarrage
    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
  </script>
</body>
</html>
